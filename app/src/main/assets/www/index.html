<h1>HelloWorld</h1>
<p id="1"></p>
<script src="https://unpkg.com/vconsole@latest/dist/vconsole.min.js"></script>
<script>
    // VConsole 默认会挂载到 `window.VConsole` 上
    var vConsole = new window.VConsole();

    const EasyViewAPI = function (url) {
        this.url = url || `ws://${location.host}/api/v1`;
        this.ws = null
        this.Tasks = {};
        this.guuid = () => {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = Math.random() * 16 | 0,
                    v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        this.connect = async function () {
            console.log("New Connection Established");
            return new Promise((resolve, reject) => {
                this.ws = new WebSocket(this.url);
                this.ws.onopen = function () {
                    resolve();
                };
                this.ws.onerror = function (err) {
                    reject(err);
                };
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.id && this.Tasks[data.id]) {
                        const task = this.Tasks[data.id];
                        task.callbacker(data.status == "success", data.msg, data.data);
                        delete this.Tasks[data.id];
                    }
                };
            });
        };

        this.actions = [
            "SYSTEM$GET_SYSTEM_INFO",
            "UTILS$PING_WITH_TIME",
            "WIFI$WIFI_SCAN"
        ]
        this.excute = async function (action, data) {
            if (!this.actions.includes(action)) {
                throw new Error(`Action ${action} is not supported`);
            }
            if (this.ws.readyState !== WebSocket.OPEN) {
                await this.connect();
            }
            return new Promise((resolve, reject) => {
                const task_uuid = this.guuid();
                this.Tasks[task_uuid] = {
                    action: action,
                    data: data,
                    callbacker: (success, msg, data) => {
                        if (success) {
                            resolve(data);
                        } else {
                            reject(new Error(msg));
                        }
                    }
                };
                this.ws.send(JSON.stringify({
                    id: task_uuid,
                    action,
                    data
                }));
            });
        };
    };




    !!(async () => {
        const api = new EasyViewAPI();
        await api.connect();
        document.getElementById("1").innerText += JSON.stringify(await api.excute("SYSTEM$GET_SYSTEM_INFO"), null, 4);
        document.getElementById("1").innerText += JSON.stringify(await api.excute("WIFI$WIFI_SCAN"), null, 4);
    })();


</script>